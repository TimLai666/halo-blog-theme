<!doctype html>
<html lang="en" th:lang="${#locale.toLanguageTag}" class="
    bg-[var(--page-bg)] text-[14px] transition md:text-[16px]
    selection:bg-[color-mix(in_oklab,var(--primary),transparent_70%)]
    selection:text-white
  " th:fragment="html (title,hero,content,head,footer,sidebar,contentClass,pageType)"
  data-overlayscrollbars-initialize>

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title th:text="${title}"></title>

  <script th:inline="javascript">
    window.i18nResources = {
      "jsModule.colorSchemeSwitcher.dark": `[(#{jsModule.colorSchemeSwitcher.dark})]`,
      "jsModule.colorSchemeSwitcher.light": `[(#{jsModule.colorSchemeSwitcher.light})]`,
      "jsModule.colorSchemeSwitcher.auto": `[(#{jsModule.colorSchemeSwitcher.auto})]`,
      "jsModule.share.qzone": `[(#{jsModule.share.qzone})]`,
      "jsModule.share.weibo": `[(#{jsModule.share.weibo})]`,
      "jsModule.share.douban": `[(#{jsModule.share.douban})]`,
      "jsModule.share.wechat": `[(#{jsModule.share.wechat})]`,
      "jsModule.share.native": `[(#{jsModule.share.native})]`,
      "jsModule.share.windowTitle": `[(#{jsModule.share.windowTitle})]`,
      "jsModule.upvote.networkError": `[(#{jsModule.upvote.networkError})]`,
    };
  </script>

  <script th:inline="javascript">
    const themeConfig = /*[(${theme.config})]*/ {};
  </script>

  <!-- Set the theme before the page is rendered to avoid a flash -->
  <script th:inline="javascript">
    (function () {
      const DEFAULT_THEME = "auto";
      const LIGHT_MODE = "light";
      const DARK_MODE = "dark";
      const AUTO_MODE = "auto";
      const BANNER_HEIGHT = 35;
      const BANNER_HEIGHT_EXTEND = 30;
      const BANNER_HEIGHT_HOME = BANNER_HEIGHT + BANNER_HEIGHT_EXTEND;
      const PAGE_WIDTH = 75;
      const configHue = /*[[${theme.config.base.themeColor.hue}]]*/ 250;
      const banner_position = /*[[${theme.config.base.banner.position}]]*/ "center";
      const bannerOffsetByPosition = {
        top: `${BANNER_HEIGHT_EXTEND}vh`,
        center: `${BANNER_HEIGHT_EXTEND / 2}vh`,
        bottom: "0",
      };
      const bannerOffset = bannerOffsetByPosition[banner_position || "center"];

      const theme = localStorage.getItem("color-scheme-fuwari") || DEFAULT_THEME;
      switch (theme) {
        case LIGHT_MODE:
          document.documentElement.classList.remove("dark");
          break;
        case DARK_MODE:
          document.documentElement.classList.add("dark");
          break;
        case AUTO_MODE:
          if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
            document.documentElement.classList.add("dark");
          } else {
            document.documentElement.classList.remove("dark");
          }
      }

      const hue = localStorage.getItem("hue") || configHue;
      document.documentElement.style.setProperty("--hue", hue);

      let offset = Math.floor(window.innerHeight * (BANNER_HEIGHT_EXTEND / 100));
      offset = offset - (offset % 4);
      document.documentElement.style.setProperty("--banner-height-extend", `${offset}px`);
      document.documentElement.style.setProperty("--page-width", `${PAGE_WIDTH}rem`);
      document.documentElement.style.setProperty("--configHue", `${configHue}`);
      document.documentElement.style.setProperty("--banner-height", `${BANNER_HEIGHT}vh`);
      document.documentElement.style.setProperty("--banner-height-home", `${BANNER_HEIGHT_HOME}vh`);
      document.documentElement.style.setProperty("--bannerOffset", bannerOffset);
    })();
  </script>

  <script type="application/json" id="theme-config" th:utext="${theme.config}"></script>

  <th:block th:if="${theme.config.development.enabled}">
    <script type="module" src="http://localhost:5173/@vite/client"></script>
    <script type="module" src="http://localhost:5173/main.ts"></script>
  </th:block>

  <th:block th:unless="${theme.config.development.enabled}">
    <link rel="stylesheet" th:href="@{/assets/dist/main.css?v={version}(version=${theme.spec.version})}" />
    <link rel="manifest" th:href="@{/assets/dist/.vite/manifest.json}" />
    <script type="module" th:src="@{/assets/dist/main.js?v={version}(version=${theme.spec.version})}"></script>
  </th:block>

  <th:block th:if="${head != null}">
    <th:block th:replace="${head}" />
  </th:block>
</head>

<body class="
      min-h-screen transition
      text-black/80 dark:text-white/85
      bg-[radial-gradient(80rem_40rem_at_50%_-10rem,rgba(255,255,255,.10),transparent_70%)]
      dark:bg-[radial-gradient(80rem_40rem_at_50%_-10rem,rgba(255,255,255,.06),transparent_70%)]
    " th:attr="data-page-type=${pageType}"
  th:classappend="|${pageType == 'home' ? 'is-home' : ''} ${theme.config.base.banner.enable ? ' enable-banner' : ''}|"
  data-overlayscrollbars-initialize>
  <th:block th:replace="~{modules/config-carrier}" />
  <th:block th:replace="~{modules/top-row}" />
  <th:block th:if="${theme.config.base.banner.enable}">
    <th:block th:replace="~{modules/banner-wrapper}" />
  </th:block>

  <!-- (Neural) Floating stage under banner -->
  <div class="pointer-events-none absolute z-30 w-full" style="top: calc(35vh - 3.5rem)">
    <div class="pointer-events-auto relative mx-auto max-w-[var(--page-width)]">
      <!-- subtle frame glow -->
      <div class="
            absolute -inset-2 rounded-[calc(var(--radius-large)_+_12px)]
            opacity-70 blur-2xl
            bg-[radial-gradient(40rem_12rem_at_50%_0,rgba(255,255,255,.16),transparent_70%)]
            dark:bg-[radial-gradient(40rem_12rem_at_50%_0,rgba(255,255,255,.10),transparent_70%)]
          " aria-hidden="true"></div>

      <div id="main-grid" class="
            relative
            left-0 right-0 mx-auto
            grid w-full
            grid-cols-[17.5rem_auto]
            grid-rows-[auto_1fr_auto]
            gap-4 px-0 transition duration-700
            md:px-4 lg:grid-rows-[auto]
          ">
        <th:block th:if="${theme.config.base.banner.credit.enable}" th:replace="~{modules/widgets/banner-credit}" />

        <!-- Sidebar stays, but we visually treat it as a control panel -->
        <div class="
              lg:sticky lg:top-14
              h-fit
              rounded-[var(--radius-large)]
              border border-white/10
              bg-white/40 dark:bg-white/5
              backdrop-blur-xl
              shadow-[0_20px_60px_rgba(0,0,0,.12)]
              dark:shadow-[0_20px_60px_rgba(0,0,0,.35)]
            ">
          <th:block th:replace="~{modules/sideBar}" />
        </div>

        <!-- Main content -->
        <main id="swup-container" class="
              transition-swup-fade col-span-2 overflow-hidden lg:col-span-1
              rounded-[var(--radius-large)]
              border border-white/10
              bg-white/55 dark:bg-white/6
              backdrop-blur-xl
              shadow-[0_20px_60px_rgba(0,0,0,.10)]
              dark:shadow-[0_24px_80px_rgba(0,0,0,.40)]
            ">
          <div id="content-wrapper" class="
                onload-animation
                relative
                p-3 md:p-4
              ">
            <!-- inner hairline + corner vibe -->
            <div class="
                  pointer-events-none absolute inset-0
                  rounded-[var(--radius-large)]
                  ring-1 ring-white/10
                " aria-hidden="true"></div>

            <!-- page content -->
            <div class="relative">
              <th:block th:replace="${content}" />
            </div>

            <!-- Footer inside for lg -->
            <div class="footer onload-animation col-span-2 hidden lg:block">
              <th:block th:replace="~{modules/footer}" />
            </div>
          </div>
        </main>

        <!-- Footer for mobile -->
        <div class="
              footer onload-animation col-span-2 block lg:hidden
              rounded-[var(--radius-large)]
              border border-white/10
              bg-white/45 dark:bg-white/6
              backdrop-blur-xl
            ">
          <th:block th:replace="~{modules/footer}" />
        </div>
      </div>

      <th:block th:replace="~{modules/widgets/back-to-top}" />
    </div>

    <!-- Under-banner layer: TOC only -->
    <div class="absolute z-0 hidden w-full 2xl:block">
      <div class="relative mx-auto max-w-[var(--page-width)]">
        <th:block th:if="${theme.config.post.enable_toc}">
          <div id="toc-wrapper"
            class="absolute -right-[var(--toc-width)] top-0 hidden w-[var(--toc-width)] items-center transition lg:block"
            th:classappend="|${theme.config.base.banner.enable ? 'toc-hide' : ''}|">
            <div id="toc-inner-wrapper" class="
                  hide-scrollbar fixed top-14 h-[calc(100vh_-_20rem)]
                  w-[var(--toc-width)]
                  overflow-x-hidden overflow-y-scroll
                  rounded-[var(--radius-large)]
                  border border-white/10
                  bg-white/45 dark:bg-white/6
                  backdrop-blur-xl
                  shadow-[0_24px_80px_rgba(0,0,0,.12)]
                  dark:shadow-[0_24px_80px_rgba(0,0,0,.40)]
                ">
              <div id="toc" class="transition-swup-fade h-full w-full">
                <div class="h-6 w-full"></div>
                <div class="toc px-2"></div>
                <div class="h-6 w-full"></div>
              </div>
            </div>
          </div>
        </th:block>

        <th:block th:unless="${theme.config.post.enable_toc}">
          <div id="toc"></div>
        </th:block>
      </div>
    </div>
  </div>

  <div id="page-height-extend" class="hidden h-[300vh]"></div>
</body>

</html>